1. Executive Context

The BOB platform is a Firebase Firestore‚Äìbased productivity system for managing Goals ‚Üí Stories ‚Üí Tasks, sprints, habits, calendar blocks, and health integrations.

The current release (v3.0.8) has introduced critical regressions:
	‚Ä¢	New entities (Goals, Stories, Tasks) are not surfacing in boards (Kanban, Planner) or tables.
	‚Ä¢	Side panel editing (previously implemented for inline CRUD) is missing.
	‚Ä¢	Defence/reference numbers (refs like GOAL-###, STRY-###, TASK-###) not visible in list/kanban views after creation.

These must be treated as P1 blockers in v3.0.9.

‚∏ª

2. Priority Requirements (Baseline from v3.0.7)

The following remain in scope and must be maintained/fixed where broken:
	1.	Sprint Planning (2-D Matrix Planner) ‚Äì vertical swimlanes per sprint; horizontal by Theme‚ÜíGoal‚ÜíSubgoal.
	2.	Current Sprint Kanban ‚Äì execution view with inline task subgrid.
	3.	Calendar Blocking & AI Scheduling ‚Äì with Google Calendar bidirectional sync.
	4.	Daily LLM Email Digest ‚Äì tasks due, focus stories, sprint pulse, AI narrative.
	5.	Health & Nutrition Integrations ‚Äì Strava, Runna, MyFitnessPal ingestion.
	6.	iOS Reminders Sync ‚Äì two-way, ~60s latency.
	7.	Mobile View ‚Äì ‚ÄúImportant Now‚Äù with habits strip.
	8.	Test Automation ‚Äì Selenium + side-door auth.
	9.	Theme Colour Inheritance ‚Äì single source of truth from theme_settings.
	10.	Pragmatic Drag & Drop Refactor ‚Äì fractional ranks, consistent across all tables/kanbans/planner.

‚∏ª

3. Critical Defects & Gaps (v3.0.8 ‚Üí v3.0.9)

üî¥ P1 Issues (Blockers)
	1.	Boards & Tables Not Talking to DB
	‚Ä¢	New Goals, Stories, Tasks created successfully in Firestore but do not appear in:
	‚Ä¢	Modern Goals Table
	‚Ä¢	Story/Task Tables
	‚Ä¢	Current Sprint Kanban
	‚Ä¢	Sprint Planner Matrix
	‚Ä¢	Likely cause: listeners not wired to new schema fields (rank, ref, themeId, rankByCell), or queries filtering incorrectly.
	2.	Side Panel Editing Missing
	‚Ä¢	Previously present side panel for CRUD/editing has disappeared.
	‚Ä¢	Must reinstate side-panel editing with parity to v3.0.6.
	3.	Ref Numbers Not Displayed
	‚Ä¢	Entities have ref (GOAL-###, STRY-###, TASK-###) but refs not shown in list rows, kanban cards, or side panels.
	‚Ä¢	Users cannot distinguish entities without them.

‚∏ª

üü° P2 Issues (High Priority, not blockers)
	1.	Drag & Drop Persistence Inconsistent
	‚Ä¢	Some Kanban/table moves not persisting rank correctly (order lost after refresh).
	‚Ä¢	Planner in-cell reordering may not update rankByCell.
	2.	UI State Not Persisting
	‚Ä¢	Sprint Planner row expansion state (ui_state.plannerRowExpansion) resets on reload.
	3.	Theme Colour Cascade Incomplete
	‚Ä¢	New entities sometimes appear with no colour until refresh.
	‚Ä¢	useThemeColor hook must compute on create, not just on load.

‚∏ª

üü¢ P3 Issues (Enhancements / Polish)
	1.	Accessibility Testing Gaps
	‚Ä¢	Drag/drop keyboard flows partially unimplemented (Kanban accessible, Planner not).
	2.	Observability
	‚Ä¢	Missing logs for Firestore listener errors (difficult to debug blank states).
	3.	Undo Toast
	‚Ä¢	Implemented in Planner, not in Goals/Tasks tables.

‚∏ª

4. Schema Deltas (Recap v3.0.7 ‚Üí v3.0.9)

Entities:
	‚Ä¢	stories: ref, goalId, subGoalId?, sprintId?, rank?, rankByLane?, rankByCell?, dragLockVersion?, themeId?, taskCount?, doneTaskCount?.
	‚Ä¢	tasks: importanceScore?, isImportant?, reminderId?, rank?.
	‚Ä¢	sprints: ref, orderIndex|rank, objective?, status, notes?.
	‚Ä¢	calendar_blocks: storyId?, habitId?, subTheme?, googleEventId?, isAiGenerated?, themeId?, conflictVersion?, supersededBy?.
	‚Ä¢	theme_settings: per-user, palette + default.
	‚Ä¢	ui_state: row expansion, visible sprints.
	‚Ä¢	sub_goals: nested under goals or top-level.

‚∏ª

5. Non-Functional Requirements (Unchanged)
	‚Ä¢	Performance: DnD perceived <150ms.
	‚Ä¢	Accessibility: WCAG AA colours, keyboard DnD, ARIA roles.
	‚Ä¢	Observability: logs for sync failures, digest times, listener errors.
	‚Ä¢	Resilience: conflict handling for calendar and DnD.

‚∏ª

6. P1 Fix Specification

Boards/Modern Tables not syncing
	‚Ä¢	Check all Firestore listeners:
	‚Ä¢	Must query by ownerUid + active sprintId|goalId|status.
	‚Ä¢	Must include rank ordering.
	‚Ä¢	Ensure denormalised fields (taskCount, doneTaskCount) populated by triggers.
	‚Ä¢	Update UI binding: tables/kanbans must subscribe to new schema fields.
	‚Ä¢	Verify security rules: ensure read access not blocked for new collections (sub_goals, ui_state, theme_settings).
	‚Ä¢	Add observability: console + server logs for listener failures.

Side Panel
	‚Ä¢	Reinstate side panel component (GoalSidePanel.tsx, StorySidePanel.tsx, TaskSidePanel.tsx).
	‚Ä¢	Ensure editing updates propagate instantly to DB and board/table.

Ref Display
	‚Ä¢	Always show ref (GOAL-###, STRY-###, TASK-###) in:
	‚Ä¢	Table primary key column.
	‚Ä¢	Kanban card header.
	‚Ä¢	Side panel title.

‚∏ª

7. Developer Tasks (v3.0.9)
	1.	Fix Firestore listeners for Goals, Stories, Tasks across boards/tables.
	2.	Reinstate side panel CRUD components.
	3.	Add ref display across UI.
	4.	Audit & patch DnD persistence (Planner, Kanban).
	5.	Persist ui_state.plannerRowExpansion.
	6.	Ensure useThemeColor fires on create.
	7.	Expand test coverage:
	‚Ä¢	Listener wiring (mock DB events).
	‚Ä¢	P1 regressions fixed.
	‚Ä¢	DnD reorders across Planner + Kanban.
	‚Ä¢	Ref display in UI.

‚∏ª

8. Prompt for AO (Code Review Agent)

You can hand this directly to the reviewing AI:

Prompt for AO:
Review the BOB v3.0.9 codebase against this document. Identify and repair all discrepancies, focusing first on P1 defects:
	1.	Firestore listeners not surfacing new Goals/Stories/Tasks in boards/tables.
	2.	Missing side-panel editing for entities.
	3.	Ref numbers not displayed.

Ensure boards, tables, and Planner are wired to schema fields (rank, ref, themeId, rankByCell) and queries include ordering. Reinstate side panels with CRUD parity. Verify ref display everywhere. Then address P2/P3 issues (DnD persistence, theme cascade, observability, undo toast). Confirm all requirements in this document are implemented and code matches schema.

Deliver a list of fixed files, new tests, and updated schema bindings.

‚∏ª

9. Conclusion

This v3.0.9 handoff covers all priority requirements, adds pragmatic DnD, theme colour inheritance, and now documents critical regressions introduced in v3.0.8.

The immediate goal is restoring functional parity (entities surfacing, side panel editing, ref display) while ensuring schema compliance and consistency across boards, tables, and planner.

This document is the single source of truth for the reviewing AI to validate and repair the codebase.

‚∏ª
